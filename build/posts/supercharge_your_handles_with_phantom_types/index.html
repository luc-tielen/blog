<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="description" content="FP -&gt; Compilers -&gt; Logic -&gt; Blog">
    <meta name="author" content="Luc Tielen">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@luctielen">
<meta name="twitter:creator" content="@luctielen">
<meta name="twitter:title" content="Supercharge your handles using phantom types">
    <meta name="twitter:description" content="">
        <title>Supercharge your handles using phantom types</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Amaranth&family=Titillium+Web&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">
  </head>
</head>
<body>
  <header>
    <nav>
      <a href="/">Blog</a>
      <a href="/videos">Videos</a>
      <a href="/about">About</a>
      <div class="social">
        <a href="https://twitter.com/luctielen">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M16 3.538a6.461 6.461 0 01-1.884.516 3.301 3.301 0 001.444-1.816 6.607 6.607 0 01-2.084.797 3.28 3.28 0 00-2.397-1.034 3.28 3.28 0 00-3.197 4.028 9.321 9.321 0 01-6.766-3.431 3.284 3.284 0 001.015 4.381A3.301 3.301 0 01.643 6.57v.041A3.283 3.283 0 003.277 9.83a3.291 3.291 0 01-1.485.057 3.293 3.293 0 003.066 2.281 6.586 6.586 0 01-4.862 1.359 9.286 9.286 0 005.034 1.475c6.037 0 9.341-5.003 9.341-9.341 0-.144-.003-.284-.009-.425a6.59 6.59 0 001.637-1.697z"/></svg>
      </a>
      <a href="https://github.com/luc-tielen">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 .198a8 8 0 00-2.529 15.591c.4.074.547-.174.547-.385 0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954 0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117 0 0 .672-.215 2.201.82A7.672 7.672 0 018 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147 0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481 0 1.07-.009 1.932-.009 2.195 0 .213.144.462.55.384A8 8 0 008.001.196z"/></svg>
      </a>
      <a href="https://twitch.tv/luctielen">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M2.149 0l-1.612 4.119v16.836h5.731v3.045h3.224l3.045-3.045h4.657l6.269-6.269v-14.686h-21.314zm19.164 13.612l-3.582 3.582h-5.731l-3.045 3.045v-3.045h-4.836v-15.045h17.194v11.463zm-3.582-7.343v6.262h-2.149v-6.262h2.149zm-5.731 0v6.262h-2.149v-6.262h2.149z"/></svg>
      </a>
      <a href="https://www.youtube.com/channel/UCeMz1NwTQlkhQvIFYMZoAJQ">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
        </a>
      <a href="/atom.xml">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M2.13 11.733c-1.175 0-2.13.958-2.13 2.126 0 1.174.955 2.122 2.13 2.122a2.126 2.126 0 002.133-2.122 2.133 2.133 0 00-2.133-2.126zM.002 5.436v3.067c1.997 0 3.874.781 5.288 2.196a7.45 7.45 0 012.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006 0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824 0 .006 0z"/></svg>
        </a>
      </div>
    </nav>
  </header>
  <main class="post">
    <h1>Supercharge your handles using phantom types</h1>
    <!--
    <span class="date"></span>
    -->
    <div class="tags">
      <span class="tag tag-haskell"><a href="/tag/haskell">haskell</a></span>
    </div>
    <p>In this article, I show how to use phantom types in combination with the "Handle pattern" to create more type-safe and user-friendly APIs in Haskell. I do this based on my experience adding this idea to the <a href="https://github.com/luc-tielen/souffle-haskell">souffle-haskell</a> library.</p>
<h2 id="a-quick-recap">A quick recap</h2>
<p>Jasper van der Jeugt has <a href="https://jaspervdj.be/posts/2018-03-08-handle-pattern.html">blogged</a> about the handle pattern in the past. In summary, he recommends using handles when interfacing external services (such as a database or file) with Haskell. A handle type should be created representing access to that service; as well as functions for communicating with the external service using that handle.</p>
<p>Here's what the handle pattern could look like for an external key-value store:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">-- Internals of the handle data type are opaque for external users</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">data</span> <span class="dt">DBHandle</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="ot">get ::</span> <span class="dt">DBHandle</span> <span class="ot">-&gt;</span> <span class="dt">Key</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Value</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="ot">put ::</span> <span class="dt">DBHandle</span> <span class="ot">-&gt;</span> <span class="dt">Key</span> <span class="ot">-&gt;</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span></code></pre></div>
<h2 id="applying-the-handle-pattern-to-souffle-haskell">Applying the handle pattern to souffle-haskell</h2>
<p>In the souffle-haskell library, the handle pattern also turned out to be a great fit. The library exposes functionality for communicating with the Souffle Datalog language, which can be viewed as an external resource. Here's what the top level API looks like (simplified):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">-- Handle type for communicating with the external Datalog program.</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">data</span> <span class="dt">Handle</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">-- Monad for performing Souffle-related actions in.</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">newtype</span> <span class="dt">SouffleM</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">-- Many different functions for communicating with Souffle.</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">-- Note how all of these functions take a handle as an argument.</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="ot">addFact ::</span> <span class="dt">Fact</span> a <span class="ot">=&gt;</span> <span class="dt">Handle</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> ()</span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="ot">getFacts ::</span> <span class="dt">Fact</span> a <span class="ot">=&gt;</span> <span class="dt">Handle</span> <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> [a]</span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="ot">run ::</span> <span class="dt">Handle</span> <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> ()</span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">-- Many other similar functions..</span></span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">-- A function for running actions in the SouffleM monad.</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">-- Given a function that takes a handle as input and returns an action</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">-- in the SouffleM monad, this function will return the underlying IO action</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">-- that will perform all these Souffle-related actions.</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="ot">runSouffle ::</span> (<span class="dt">Handle</span> <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> a) <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span></code></pre></div>
<p>The handle pattern helped to structure the API and to take care of resource management. However, you can still mis-use this API. For example, since facts have to be pre-defined for a Souffle program, it doesn't make sense to add a fact to a Souffle program that doesnt' understand it. Can we do better and prevent these kinds of logical mistakes?</p>
<h2 id="enter-the-phantom-types">Enter the phantom types</h2>
<p>If you take a look at the previous Haskell snippet, you will see that every function takes the handle datatype as an argument. This makes it a great candidate for doing compile-time checks based on type level information. To see how we could do this for the snippet above, let's first introduce a phantom type variable to our handle:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="ot">{-# LANGUAGE RoleAnnotations #-}</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">-- &quot;prog&quot; is a type variable referring to a corresponding Datalog program</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">data</span> <span class="dt">Handle</span> prog <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">-- The next line is needed to prevent users from coercing between</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">-- handles with different phantom types:</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="kw">type</span> role <span class="dt">Handle</span> nominal</span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="kw">newtype</span> <span class="dt">SouffleM</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="ot">addFact ::</span> <span class="dt">Fact</span> a <span class="ot">=&gt;</span> <span class="dt">Handle</span> prog <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> ()</span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="ot">getFacts ::</span> <span class="dt">Fact</span> a <span class="ot">=&gt;</span> <span class="dt">Handle</span> prog <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> [a]</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="ot">run ::</span> <span class="dt">Handle</span> prog <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> ()</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">-- Here we add an extra argument, so that Haskell can infer what type the</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co">-- phantom type of the handle should be.</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">-- Note: another approach is to use &quot;TypeApplications&quot; (doesn&#39;t require an</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">-- extra argument) to tell Haskell what the type of &quot;prog&quot; should be.</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="ot">runSouffle ::</span> prog <span class="ot">-&gt;</span> (<span class="dt">Handle</span> prog <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> a) <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span></code></pre></div>
<p>This phantom type variable by itself doesn't do that much yet except for catching some type errors, but it does give us a starting point to start adding information on the type-level. One way to do this is by adding a constraint (based on the phantom type) to limit the possible scenarios a function can be used in. Conceptually this looks as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="ot">myConstrainedFunc ::</span> <span class="dt">MyConstraint</span> prog <span class="ot">=&gt;</span> <span class="dt">Handle</span> prog <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> ()</span></code></pre></div>
<h2 id="taking-it-a-step-further-with-typefamilies">Taking it a step further with TypeFamilies</h2>
<p>For simple usecases the above would suffice, but we need some more expressivity if we want to check that a fact isn't part of a Souffle program. To achieve this, we can make use of a combination of the TypeFamilies extension and "TypeError" in GHC to create sophisticated constraints at the type-level:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">-- Add these extensions to top of the file.</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ot">{-# LANGUAGE TypeOperators #-}</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ot">{-# LANGUAGE DataKinds #-}</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ot">{-# LANGUAGE StandaloneKindSignatures #-}</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ot">{-# LANGUAGE UndecidableInstances #-}</span></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">-- With the approach introduced here, some type families will only</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">-- return a constraint in the error cases (containing a TypeError).</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">-- GHC will thus think the constraints are redundant.</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="co">-- This turns off that warning.</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="ot">{-# OPTIONS_GHC -Wno-redundant-constraints #-}</span></span>
<span id="cb5-13"><a href="#cb5-13"></a></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="kw">import</span> <span class="dt">Data.Kind</span> (<span class="dt">Type</span>)</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="kw">import</span> <span class="dt">GHC.TypeLits</span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">-- Elem is a type family that checks if a type is contained in a</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="co">-- list of types. It returns a type-level boolean.</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="kw">type</span> <span class="dt">Elem</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> [<span class="dt">Type</span>] <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Elem</span> a as <span class="kw">where</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="dt">Elem</span> _ &#39;[]       <span class="ot">=</span> <span class="dt">&#39;False</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="dt">Elem</span> x (x &#39;<span class="op">:</span> _)  <span class="ot">=</span> <span class="dt">&#39;True</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>  <span class="dt">Elem</span> x (_ &#39;<span class="op">:</span> xs) <span class="ot">=</span> <span class="dt">Elem</span> x xs</span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="co">-- Example usage of Elem: x won&#39;t compile when you try to use it</span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="co">-- However this gives us a rather cryptic error message:</span></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="co">--  • Couldn&#39;t match type ‘&#39;False’ with ‘&#39;True’</span></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="co">--      arising from a use of ‘x’</span></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="ot">x ::</span> <span class="dt">Elem</span> <span class="dt">Int</span> &#39;[<span class="dt">Char</span>, <span class="dt">Bool</span>] <span class="op">~</span> <span class="dt">&#39;True</span> <span class="ot">=&gt;</span> <span class="dt">Int</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>x <span class="ot">=</span> <span class="dv">1234</span></span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="co">-- To improve this, let&#39;s add a type-level assertion.</span></span>
<span id="cb5-33"><a href="#cb5-33"></a><span class="co">-- If the assertion is satisfied, everything is ok.</span></span>
<span id="cb5-34"><a href="#cb5-34"></a><span class="co">-- If the assertion fails, a custom type error is returned to the user.</span></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="kw">type</span> <span class="dt">Assert</span><span class="ot"> ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ErrorMessage</span> <span class="ot">-&gt;</span> <span class="dt">Constraint</span></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Assert</span> condition message <span class="kw">where</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>  <span class="dt">Assert</span> <span class="dt">&#39;True</span> _ <span class="ot">=</span> ()</span>
<span id="cb5-38"><a href="#cb5-38"></a>  <span class="dt">Assert</span> <span class="dt">&#39;False</span> msg <span class="ot">=</span> <span class="dt">TypeError</span> msg</span>
<span id="cb5-39"><a href="#cb5-39"></a></span>
<span id="cb5-40"><a href="#cb5-40"></a><span class="co">-- Example using Assert: y won&#39;t compile if a is not of type Bool,</span></span>
<span id="cb5-41"><a href="#cb5-41"></a><span class="co">-- giving us a custom type error instead.</span></span>
<span id="cb5-42"><a href="#cb5-42"></a><span class="ot">constrainedId ::</span> <span class="dt">Assert</span> (<span class="dt">Elem</span> a &#39;[<span class="dt">Bool</span>]) (<span class="dt">&#39;ShowType</span> <span class="st">&quot;This won&#39;t compile!&quot;</span>)</span>
<span id="cb5-43"><a href="#cb5-43"></a>              <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a</span>
<span id="cb5-44"><a href="#cb5-44"></a>constrainedId <span class="ot">=</span> <span class="fu">id</span></span></code></pre></div>
<p>It is now possible to write a check to see if a fact is contained in a Souffle program:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">-- Type family for declaring which fact types belong to a Souffle program</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">type</span> <span class="dt">ProgramFacts</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> [<span class="dt">Type</span>]</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">ProgramFacts</span> a</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">-- The actual check to see if a program contains a certain fact type</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="kw">type</span> <span class="dt">ContainsFact</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Constraint</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">ContainsFact</span> prog fact <span class="kw">where</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="dt">ContainsFact</span> prog fact <span class="ot">=</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="dt">Assert</span> (<span class="dt">Elem</span> fact (<span class="dt">ProgramFacts</span> prog))</span>
<span id="cb6-10"><a href="#cb6-10"></a>           (<span class="dt">&#39;ShowType</span> <span class="st">&quot;Unknown fact for Souffle program&quot;</span>)</span></code></pre></div>
<p>We can now add this type-level assertion to our initial Haskell snippet:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">addFact ::</span> (<span class="dt">Fact</span> a, <span class="dt">ContainsFact</span> prog a) <span class="ot">=&gt;</span> <span class="dt">Handle</span> prog <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> ()</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ot">getFacts ::</span> (<span class="dt">Fact</span> a, <span class="dt">ContainsFact</span> prog a) <span class="ot">=&gt;</span> <span class="dt">Handle</span> prog <span class="ot">-&gt;</span> <span class="dt">SouffleM</span> [a]</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">-- Rest unmodified..</span></span>
<span id="cb7-5"><a href="#cb7-5"></a></span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">-- In our application code we can specify that Fact1 and Fact2 belong to</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">-- the Souffle program managed by &#39;MyProgram&#39;:</span></span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="kw">data</span> <span class="dt">MyProgram</span> <span class="ot">=</span> <span class="dt">MyProgram</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="kw">data</span> <span class="dt">Fact1</span> <span class="ot">=</span> <span class="dt">Fact1</span> <span class="dt">String</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="kw">data</span> <span class="dt">Fact2</span> <span class="ot">=</span> <span class="dt">Fact2</span> <span class="dt">String</span></span>
<span id="cb7-13"><a href="#cb7-13"></a></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="kw">type</span> <span class="kw">instance</span> <span class="dt">ProgramFacts</span> <span class="dt">MyProgram</span> <span class="ot">=</span> &#39;[<span class="dt">Fact1</span>, <span class="dt">Fact2</span>]</span></code></pre></div>
<p>If we now try to add a fact to a Souffle program that doesn't understand it, it won't compile anymore. Great!</p>
<h2 id="conclusion">Conclusion</h2>
<p>Phantom types are a lightweight and powerful technique for adding more type-safety to your code. Combined with the handle pattern and type families, it allows you to write expressive type-level assertions that are verified by the compiler.</p>
<p>Like mentioned before, the code in the post is based on my souffle-haskell library. I simplified the types in this post to keep the mental overhead as minimal as possible. Here's the <a href="https://github.com/luc-tielen/souffle-haskell/commit/4839959a9b2f45198747355466f066d768c6059a">original commit</a> where I introduced the idea in the code.</p>
<p>If you are interested in more content like this, follow me on <a href="https://twitter.com/luctielen">Twitter</a>. Feel free to contact me if you have any questions or comments about this topic.</p>
    <img src="https://api.stathat.com/c?ukey=MTk2NzAgWkL6UC1F__NJ8FQSQf0CiA~~&key=27ZUKzMSpTwf7JNpDPdlHiA0WVlO&count=1"
         style="display:none;" width="1" height="1"/>
  </main>
</body>
